# Read-Only Git Server for Rabit Burrows

Share your Rabit burrows via Git with authenticated clients while maintaining read-only access. This setup provides:

- **SSH key authentication** — No passwords, secure access
- **Read-only access** — Clients can clone/fetch but not push
- **Host-friendly** — Work with repos normally on your machine (no root required)
- **Thin wrapper** — Your existing workflow unchanged, server adds read-only layer

## Quick Start

```bash
# 1. Initialize the server
./setup.sh

# 2. Add your SSH public key (for testing)
cat ~/.ssh/id_ed25519.pub >> ssh-keys/authorized_keys

# 3. Link an existing burrow/repo
ln -s /path/to/my-burrow repos/my-burrow.git

# 4. Start the server
docker compose up -d

# 5. Test cloning (from any machine with the private key)
git clone ssh://git@localhost:2222/srv/git/my-burrow.git
```

## How It Works

```
┌─────────────────────────────────────────────────────────────────┐
│                        Host Machine                              │
│                                                                  │
│  ┌──────────────────┐    ┌──────────────────────────────────┐   │
│  │  Your Burrow     │    │  Git Server Container            │   │
│  │  /home/you/docs  │◄───┤  (rockstorm/git-server)          │   │
│  │                  │ ro │                                   │   │
│  │  - Edit freely   │    │  - SSH on port 2222              │   │
│  │  - git commit    │    │  - Blocks push (read-only)       │   │
│  │  - git push      │    │  - Serves clone/fetch            │   │
│  └──────────────────┘    └──────────────────────────────────┘   │
│                                      │                           │
│  ┌──────────────────┐                │                           │
│  │  ssh-keys/       │◄───────────────┘                           │
│  │  authorized_keys │  (managed by you, no root)                 │
│  └──────────────────┘                                            │
└─────────────────────────────────────────────────────────────────┘
                                │
                                │ SSH (port 2222)
                                ▼
                    ┌───────────────────────┐
                    │  Authorized Clients   │
                    │  git clone ssh://...  │
                    │  git fetch            │
                    │  ✗ git push (blocked) │
                    └───────────────────────┘
```

## Directory Structure

```
git-readonly/
├── docker-compose.yml          # Server configuration
├── setup.sh                    # Initialization script
├── .env                        # Generated configuration
├── repos/                      # Your burrow repositories
│   └── my-burrow.git -> ...    # Symlink to your actual repo
├── ssh-keys/
│   ├── authorized_keys         # Public keys of allowed clients
│   └── host-keys/              # SSH host keys (persistent)
│       ├── ssh_host_rsa_key
│       ├── ssh_host_ed25519_key
│       └── ssh_host_ecdsa_key
└── git-shell-commands/         # Read-only enforcement
    ├── no-interactive-login    # Block shell access
    └── git-receive-pack        # Block push operations
```

## Configuration

### Environment Variables (.env)

Generated by `setup.sh`, but can be customized:

```bash
# Match your user's UID/GID for file access
HOST_UID=1000
HOST_GID=1000

# SSH port for Git access
GIT_SSH_PORT=2222

# Web server port (optional, with --profile web)
WEB_PORT=8080

# Burrow metadata (for web server)
BURROW_TITLE=My Burrow
BURROW_NAME=my-burrow.git
```

### Adding Authorized Keys

Add public keys to `ssh-keys/authorized_keys`:

```bash
# From a file
cat ~/.ssh/id_ed25519.pub >> ssh-keys/authorized_keys

# From GitHub
curl https://github.com/username.keys >> ssh-keys/authorized_keys

# From GitLab
curl https://gitlab.com/username.keys >> ssh-keys/authorized_keys

# Multiple keys (one per line)
cat >> ssh-keys/authorized_keys << 'EOF'
ssh-ed25519 AAAAC3NzaC1... alice@example.com
ssh-ed25519 AAAAC3NzaC1... bob@example.com
EOF
```

### Adding Repositories

**Option 1: Symlink existing repo (recommended)**

```bash
# Link a regular git repo (with .git directory)
ln -s /home/user/my-project repos/my-project.git

# Link a bare repo
ln -s /home/user/repos/my-burrow.git repos/my-burrow.git
```

**Option 2: Create a bare clone**

```bash
git clone --bare /path/to/repo repos/my-burrow.git
```

**Option 3: Initialize new repo**

```bash
mkdir repos/new-burrow.git
cd repos/new-burrow.git
git init --bare
```

## Usage

### Starting the Server

```bash
# Start Git server only
docker compose up -d

# Start with web server (for HTTPS access)
docker compose --profile web up -d

# View logs
docker compose logs -f

# Stop
docker compose down
```

### Client Access

Clients clone using SSH:

```bash
# Clone a burrow
git clone ssh://git@your-server:2222/srv/git/my-burrow.git

# Or with standard Git URL format
git clone git@your-server:2222/srv/git/my-burrow.git

# Fetch updates
cd my-burrow
git fetch origin
git pull origin main

# Push will be rejected
git push  # ERROR: Push access is disabled
```

### Using with .burrow.json

Reference the Git server in your burrow manifest:

```json
{
  "rbt": "0.2",
  "manifest": {
    "title": "My Documentation",
    "roots": [
      {
        "git": {
          "remote": "ssh://git@your-server:2222/srv/git/my-burrow.git",
          "ref": "refs/heads/main",
          "path": "/"
        }
      }
    ]
  }
}
```

For public access alongside private Git:

```json
{
  "roots": [
    {
      "git": {
        "remote": "ssh://git@internal.company.com:2222/srv/git/docs.git",
        "ref": "refs/heads/main"
      }
    },
    {
      "https": {
        "base": "https://docs.company.com/"
      }
    }
  ]
}
```

## Security

### Read-Only Enforcement

Push operations are blocked at multiple levels:

1. **Repository mounted read-only** (`/srv/git:ro`)
2. **git-receive-pack blocked** via custom git-shell command
3. **No interactive shell** access

### SSH Key Authentication

- Password authentication is disabled (`SSH_AUTH_METHODS=publickey`)
- Only users with keys in `authorized_keys` can connect
- Host keys are persisted to prevent MITM warnings

### File Permissions

The container runs with your UID/GID, so:
- You can edit `repos/` and `ssh-keys/` without sudo
- File permissions match your normal user
- No root access required on the host

## Workflow Example

### Publisher Workflow (Host Machine)

```bash
# Work on your burrow as normal
cd ~/my-documentation

# Edit files
vim guides/new-feature.md

# Commit changes
git add -A
git commit -m "Add new feature guide"

# Push to your main remote (GitHub, etc.)
git push origin main

# The Git server automatically serves the updated content
# (since it's a symlink to your working directory)
```

### Consumer Workflow (Client Machine)

```bash
# Initial clone
git clone ssh://git@docs.company.com:2222/srv/git/docs.git

# Later - get updates
cd docs
git pull origin main

# Use Rabit client to traverse
rabit traverse ssh://git@docs.company.com:2222/srv/git/docs.git
```

## Troubleshooting

### Permission Denied

```
Permission denied (publickey).
```

- Ensure your public key is in `ssh-keys/authorized_keys`
- Check file permissions: `chmod 600 ssh-keys/authorized_keys`
- Verify UID/GID in `.env` matches your user: `id -u && id -g`

### Host Key Verification Failed

```
Host key verification failed.
```

- First connection? Add to known_hosts: `ssh-keyscan -p 2222 localhost >> ~/.ssh/known_hosts`
- If keys changed, remove old entry: `ssh-keygen -R "[localhost]:2222"`

### Connection Refused

```
Connection refused
```

- Check if container is running: `docker compose ps`
- Verify port mapping: `docker compose port git-server 22`
- Check logs: `docker compose logs git-server`

### Push Rejected

```
fatal: Push access is disabled on this read-only server.
```

This is expected behavior! The server is intentionally read-only.

## Advanced Configuration

### Custom SSH Port

Edit `.env`:

```bash
GIT_SSH_PORT=2222
```

Or use environment variable:

```bash
GIT_SSH_PORT=22222 docker compose up -d
```

### Multiple Repositories

Simply add more symlinks or directories to `repos/`:

```bash
ln -s ~/project-a repos/project-a.git
ln -s ~/project-b repos/project-b.git
ln -s ~/docs repos/documentation.git
```

### External Network Access

For access from outside localhost, ensure:

1. Port is open in firewall
2. DNS/IP is accessible
3. Update clone URLs accordingly

```bash
# Firewall (example for ufw)
sudo ufw allow 2222/tcp

# Clone from external
git clone ssh://git@your-domain.com:2222/srv/git/my-burrow.git
```

### With Reverse Proxy (HTTPS)

See `docker-compose.examples.yml` in parent directory for Traefik integration.

## See Also

- [Rabit Specification](../../../rabit-spec-draft-2026-01-12.md) — Full RBT spec
- [rockstorm/git-server](https://github.com/rockstorm101/git-server-docker) — Base Docker image
- [Rabit Client](../../../rabit-client/) — TypeScript client implementation
