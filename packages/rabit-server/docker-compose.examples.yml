# Rabit Server - Example Docker Compose Configurations
#
# This file contains several example configurations for running rabit-server.
# Copy the relevant section to your own docker-compose.yml.

version: '3.8'

# =============================================================================
# Example 1: Simple Burrow
# Serve a single documentation directory
# =============================================================================
services:
  # Simple burrow serving local docs
  simple-burrow:
    image: rabit/server
    container_name: rabit-docs
    ports:
      - "8080:80"
    volumes:
      - ./docs:/data/burrow:ro
    environment:
      RABIT_TITLE: "My Documentation"
      RABIT_DESCRIPTION: "Project documentation and API guides"
    restart: unless-stopped

# =============================================================================
# Example 2: Warren with Multiple Burrows
# Central registry pointing to multiple content sources
# =============================================================================

  # Warren registry
  warren:
    image: rabit/server
    container_name: rabit-warren
    ports:
      - "8080:80"
    volumes:
      - ./warren:/data/warren:ro
    environment:
      RABIT_MODE: warren
      RABIT_TITLE: "Acme Documentation Hub"
      RABIT_DESCRIPTION: "Central registry for all Acme documentation"
      RABIT_BASE_URL: "http://localhost:8080/"
    restart: unless-stopped
    depends_on:
      - docs-burrow
      - api-burrow

  # Documentation burrow
  docs-burrow:
    image: rabit/server
    container_name: rabit-docs
    ports:
      - "8081:80"
    volumes:
      - ./burrows/docs:/data/burrow:ro
    environment:
      RABIT_TITLE: "User Documentation"
      RABIT_DESCRIPTION: "Guides, tutorials, and reference documentation"
      RABIT_BASE_URL: "http://localhost:8081/"
    restart: unless-stopped

  # API reference burrow
  api-burrow:
    image: rabit/server
    container_name: rabit-api
    ports:
      - "8082:80"
    volumes:
      - ./burrows/api:/data/burrow:ro
    environment:
      RABIT_TITLE: "API Reference"
      RABIT_DESCRIPTION: "REST API documentation and OpenAPI specs"
      RABIT_BASE_URL: "http://localhost:8082/"
    restart: unless-stopped

# =============================================================================
# Example 3: Production Setup with Traefik
# Uses Traefik reverse proxy with automatic HTTPS
# =============================================================================

  traefik:
    image: traefik:v2.10
    container_name: traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.letsencrypt.acme.email=admin@example.com"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./letsencrypt:/letsencrypt
    restart: unless-stopped

  docs-prod:
    image: rabit/server
    container_name: rabit-docs-prod
    volumes:
      - ./docs:/data/burrow:ro
    environment:
      RABIT_TITLE: "Documentation"
      RABIT_BASE_URL: "https://docs.example.com/"
      RABIT_CORS_ORIGINS: "https://example.com,https://app.example.com"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.docs.rule=Host(`docs.example.com`)"
      - "traefik.http.routers.docs.entrypoints=websecure"
      - "traefik.http.routers.docs.tls.certresolver=letsencrypt"
    restart: unless-stopped

# =============================================================================
# Example 4: Development Setup with Live Reload
# Auto-regenerates manifests when content changes
# =============================================================================

  dev-burrow:
    image: rabit/server
    container_name: rabit-dev
    ports:
      - "8080:80"
    volumes:
      - ./docs:/data/burrow  # Note: no :ro for development
    environment:
      RABIT_TITLE: "Development Docs"
      RABIT_AUTO_GENERATE: "true"
      RABIT_LOG_LEVEL: "debug"
    restart: unless-stopped
    # Tip: Use a file watcher to restart the container when content changes
    # Example with entr: find ./docs -name '*.md' | entr docker restart rabit-dev

# =============================================================================
# Example 5: Private Burrow with Basic Auth
# Uses nginx basic auth in front of rabit-server
# =============================================================================

  private-burrow:
    image: rabit/server
    container_name: rabit-private
    # No port exposure - accessed via auth-proxy
    volumes:
      - ./private-docs:/data/burrow:ro
    environment:
      RABIT_TITLE: "Internal Documentation"
      RABIT_CORS_ORIGINS: "https://internal.example.com"
    restart: unless-stopped

  auth-proxy:
    image: nginx:alpine
    container_name: rabit-auth-proxy
    ports:
      - "8080:80"
    volumes:
      - ./nginx-auth.conf:/etc/nginx/conf.d/default.conf:ro
      - ./htpasswd:/etc/nginx/.htpasswd:ro
    depends_on:
      - private-burrow
    restart: unless-stopped

# =============================================================================
# Networks (uncomment if needed)
# =============================================================================

# networks:
#   rabit-network:
#     driver: bridge
