# Git Server for Read-Only Burrow Sharing
#
# This configuration provides SSH-based Git access to burrows with:
# - Read-only access (clone/fetch only, no push)
# - SSH key authentication (no passwords)
# - Clean repository URLs (no /srv/git prefix)
# - Direct host directory mounting (no symlinks required)
#
# Usage:
#   1. Run ./setup.sh to initialize directories
#   2. Add public keys to ./ssh-keys/authorized_keys
#   3. Place or mount your burrow in ./repos/
#   4. docker compose up -d
#   5. Clients clone: git clone git@localhost:my-burrow
#
# The repository path in the URL matches the directory name in ./repos/

services:
  git-server:
    image: rockstorm/git-server:latest
    container_name: rabit-git-server
    restart: unless-stopped
    ports:
      # Use standard SSH port by default, customize in .env
      - "${SSH_PORT:-22}:22"
    environment:
      # Match host user's UID/GID for seamless file access
      - SSH_USER_UID=${HOST_UID:-1000}
      - SSH_USER_GID=${HOST_GID:-1000}
      # Disable password authentication - SSH keys only
      - SSH_AUTH_METHODS=publickey
      # Custom repository base path for cleaner URLs
      - GIT_BASE_PATH=/repos
    volumes:
      # Mount repositories directory directly (read-only)
      - ${REPOS_PATH:-./repos}:/repos:ro
      # Mount authorized keys from host
      - ./ssh-keys/authorized_keys:/home/git/.ssh/authorized_keys:ro
      # Custom sshd config for clean URLs
      - ./config/sshd_config:/etc/ssh/sshd_config:ro
      # Mount read-only enforcement scripts
      - ./git-shell-commands:/home/git/git-shell-commands:ro
      # Persist SSH host keys to avoid fingerprint changes
      - ./ssh-keys/host-keys:/etc/ssh/host-keys:ro
    healthcheck:
      test: ["CMD", "pgrep", "sshd"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Optional: Rabit web server alongside Git server
  # Provides HTTPS access + manifest serving
  rabit-web:
    image: rabit-server:latest
    container_name: rabit-web-server
    restart: unless-stopped
    profiles:
      - web  # Only starts with: docker compose --profile web up
    ports:
      - "${WEB_PORT:-8080}:80"
    environment:
      - RABIT_MODE=burrow
      - RABIT_TITLE=${BURROW_TITLE:-My Burrow}
      - RABIT_AUTO_GENERATE=true
      - RABIT_BASE_URL=${WEB_BASE_URL:-}
    volumes:
      # Mount the specified burrow (or first directory in repos/)
      - ${REPOS_PATH:-./repos}/${BURROW_DIR:-.}:/data/burrow:ro
    depends_on:
      - git-server

networks:
  default:
    name: rabit-git-network
